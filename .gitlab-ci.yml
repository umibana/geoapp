# GitLab CI/CD Pipeline for Multi-Platform Electron Builds
# Builds geoapp for Windows, macOS (x64 + arm64), and Linux

stages:
  - setup
  - build
  - test
  - package

variables:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

# Cache configuration for faster builds
.cache_template: &cache_config
  cache:
    key: ${CI_COMMIT_REF_SLUG}-${CI_JOB_NAME}
    paths:
      - node_modules/
      - venv/
      - backend/dist/
      - .npm/
    policy: pull-push

# ====================
# SETUP STAGE
# ====================

setup:dependencies:
  stage: setup
  image: node:${NODE_VERSION}
  <<: *cache_config
  before_script:
    - apt-get update && apt-get install -y python3 python3-venv python3-pip
  script:
    # Install Node dependencies
    - npm ci --cache .npm --prefer-offline

    # Setup Python virtual environment
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - cd backend && pip install -r requirements.txt && cd ..

    # Generate Protocol Buffers
    - npm run generate:full-stack
  artifacts:
    paths:
      - node_modules/
      - venv/
      - src/generated/
      - backend/generated/
    expire_in: 1 hour

# ====================
# BUILD STAGE (OS-Specific)
# ====================

# macOS Build - x64
build:macos:x64:
  stage: build
  tags:
    - macos  # Requires GitLab Runner with macOS tag
  dependencies:
    - setup:dependencies
  before_script:
    - source venv/bin/activate
  script:
    # Build Python backend for macOS
    - npm run build:backend

    # Build Electron app for x64
    - npm run make:mac:x64
  artifacts:
    name: "geoapp-macos-x64-${CI_COMMIT_SHORT_SHA}"
    paths:
      - out/make/**/*x64*.zip
    expire_in: 1 week
  only:
    - main
    - tags
    - merge_requests

# macOS Build - arm64
build:macos:arm64:
  stage: build
  tags:
    - macos  # Requires GitLab Runner with macOS tag
  dependencies:
    - setup:dependencies
  before_script:
    - source venv/bin/activate
  script:
    # Build Python backend for macOS (reuses from x64 build if cached)
    - npm run build:backend

    # Build Electron app for arm64
    - npm run make:mac:arm64
  artifacts:
    name: "geoapp-macos-arm64-${CI_COMMIT_SHORT_SHA}"
    paths:
      - out/make/**/*arm64*.zip
    expire_in: 1 week
  only:
    - main
    - tags
    - merge_requests

# Windows Build
build:windows:
  stage: build
  tags:
    - windows  # Requires GitLab Runner with Windows tag
  dependencies:
    - setup:dependencies
  before_script:
    - venv\Scripts\activate  # Windows path
  script:
    # Build Python backend for Windows
    - npm run build:backend

    # Build Electron app
    - npm run make:win
  artifacts:
    name: "geoapp-windows-${CI_COMMIT_SHORT_SHA}"
    paths:
      - out/make/**/*.exe
      - out/make/**/*.nupkg
    expire_in: 1 week
  only:
    - main
    - tags
    - merge_requests

# Linux Build
build:linux:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - setup:dependencies
  before_script:
    # Install build dependencies for Linux
    - apt-get update
    - apt-get install -y python3 python3-venv rpm fakeroot dpkg
    - source venv/bin/activate
  script:
    # Build Python backend for Linux
    - npm run build:backend

    # Build Electron app
    - npm run make:linux
  artifacts:
    name: "geoapp-linux-${CI_COMMIT_SHORT_SHA}"
    paths:
      - out/make/**/*.deb
      - out/make/**/*.rpm
    expire_in: 1 week
  only:
    - main
    - tags
    - merge_requests

# ====================
# TEST STAGE
# ====================

# test:unit:
#   stage: test
#   image: node:${NODE_VERSION}
#   dependencies:
#     - setup:dependencies
#   before_script:
#     - apt-get update && apt-get install -y python3 python3-venv
#     - source venv/bin/activate
#   script:
#     - npm run test:unit
#   coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
#   artifacts:
#     reports:
#       coverage_report:
#         coverage_format: cobertura
#         path: coverage/cobertura-coverage.xml
#     paths:
#       - coverage/
#     expire_in: 1 week

# test:lint:
#   stage: test
#   image: node:${NODE_VERSION}
#   dependencies:
#     - setup:dependencies
#   script:
#     - npm run lint
#     - npm run format

# E2E tests (only on Linux for speed)
# test:e2e:
#   stage: test
#   image: mcr.microsoft.com/playwright:v1.52.0-jammy
#   dependencies:
#     - setup:dependencies
#     - build:linux
#   before_script:
#     - apt-get update && apt-get install -y python3 python3-venv
#     - source venv/bin/activate
#     - npx playwright install --with-deps
#   script:
#     - npm run test:e2e
#   artifacts:
#     when: on_failure
#     paths:
#       - playwright-report/
#       - test-results/
#     expire_in: 1 week
#   allow_failure: true

# ====================
# PACKAGE STAGE (Release)
# ====================

# package:release:
#   stage: package
#   image: alpine:latest
#   dependencies:
#     - build:macos:x64
#     - build:macos:arm64
#     - build:windows
#     - build:linux
#   script:
#     - echo "Packaging release artifacts..."
#     - ls -lah out/make/
#   artifacts:
#     name: "geoapp-all-platforms-${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}"
#     paths:
#       - out/make/
#     expire_in: 1 month
#   only:
#     - tags

# ====================
# OPTIONAL: Deploy/Release Stage
# ====================

# Uncomment to auto-create GitLab releases
# release:gitlab:
#   stage: package
#   image: registry.gitlab.com/gitlab-org/release-cli:latest
#   dependencies:
#     - package:release
#   script:
#     - echo "Creating GitLab release..."
#   release:
#     tag_name: '$CI_COMMIT_TAG'
#     description: 'Release $CI_COMMIT_TAG'
#     assets:
#       links:
#         - name: 'macOS Build'
#           url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/browse/out/make/'
#         - name: 'Windows Build'
#           url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/browse/out/make/'
#         - name: 'Linux Build'
#           url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/browse/out/make/'
#   only:
#     - tags
